select  vta.area_id areaId,
        vta.area_name areaName,
        vta.zone_id zoneId,
        vta.zone_name zoneName,
        vta.sub_area_id subAreaId,
        vta.sub_area_name subAreaName,
        vta.vill_id villageId,
        vta.vill_name villageName,
        f.farmer_reg_number farmerReg,
        f.farmer_name farmerName,
        f.farmer_father_name fatherName,
        b.bank_name bankName,
        bb.branch_name branchName,
        fba.account_number accountNumber,
        fc.land_acreage acre,
        coalesce(pmd.total_bale,0) totalBale,
        coalesce(pmd.total_weight,0) buyingWeight,
        coalesce(gm.amount,0) as amount,
        flm.loan as loan,
        flm.loan_payment realisedLoan,
        flm.loan_balance loanBalance
from    farmer f
JOIN    farmer_contact fc on f.id = fc.farmer_id
AND     fc.season_id = :seasonId
JOIN    v_territory_all vta on f.territory_id=vta.vill_id
        AND case when :areaId is not null then vta.area_id=:areaId else true end
        AND case when :zoneId is not null then vta.zone_id=:zoneId else true end
        AND case when :subAreaId is not null then vta.sub_area_id=:subAreaId else true end
JOIN    farmer_bank_account fba on f.id = fba.farmer_id
JOIN    bank_branch bb on bb.id=fba.bank_branch_id
JOIN    bank b on b.id=bb.bank_id
JOIN    (select  farmer_contact_id,
                 sum(case when loan_amount >0 then loan_amount else 0 end) loan,
                 sum(case when loan_amount <0 then loan_amount else 0 end) loan_payment,
                 sum(case when loan_amount >0 then loan_amount else 0 end) - abs(sum(case when loan_amount <0 then loan_amount else 0 end)) loan_balance
         from    farmer_loan_main fm
         JOIN    farmer_contact fc on fm.farmer_contact_id=fc.id
         AND     fc.season_id = :seasonId
         group by farmer_contact_id) flm on fc.id=flm.farmer_contact_id
LEFT    JOIN (select  pm.farmer_contact_id,
                      count(bale_id) total_bale,
                      sum(pd.weight) as total_weight
              from    purchase_main pm
                          JOIN    purchase_details pd on pm.id = pd.purchase_main_id
                          JOIN    farmer_contact fc on pm.farmer_contact_id=fc.id
                  AND     fc.season_id = :seasonId
              group   by pm.farmer_contact_id) pmd
        ON fc.id=pmd.farmer_contact_id
LEFT    JOIN (select  pm.farmer_contact_id,
                      sum(pm.grand_total) as amount
              from    purchase_main pm
                          JOIN    farmer_contact fc on pm.farmer_contact_id=fc.id
                  AND     fc.season_id = :seasonId
              group   by pm.farmer_contact_id) gm
        ON fc.id=gm.farmer_contact_id
order by vta.area_id, vta.zone_id, vta.sub_area_id, vta.vill_id, f.farmer_reg_number
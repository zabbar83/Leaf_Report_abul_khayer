select  t3.bale_code baleCode,
        t3.purchase_date purchaseDate,
        t3.variety_name varietyName,
        g.grade_name gradeName,
        case when t3.weight_recipient='PURCHASE' then 'BUYER'
             when t3.weight_recipient='CLASSIFICATION_FIRST' then 'CLASSIFIER'
        end weightRecipient,
        t3.Weight weight,
        t3.reWeight reWeight
from (select  t1.id bale_id,t1.bale_code,
        t1.weight_recipient,
        t1.Weight,
        t1.reWeight,
        t1.variety_name,
        t1.purchase_date,
        RANK() OVER (PARTITION BY t1.bale_code ORDER BY t2.id DESC) rank
from (select b.id,b.bale_code                 bale_code,
             bw.add_date_time,
             pm.purchase_date,
             bw.weight_recipient,
             bw.weight - bs.sacks_weight Weight,
             pd.weight                   reWeight,
             v.variety_name
      from purchase_main pm
               join purchase_details pd on pm.id = pd.purchase_main_id
               join farmer_contact fc on (fc.id = pm.farmer_contact_id and fc.season_id = :seasonId)
               join farmer f on pm.farmer_id = f.id
               join v_territory_all vta on f.territory_id = vta.vill_id
               join bale_weight bw on pd.bale_id = bw.bale_id and bw.weight_recipient !='RE_WEIGHT'
               join bale_sacks bs on pd.bale_id = bs.bale_id and bs.sack_type_selector = 'BUYER'
               join bale b on b.id = bw.bale_id
               join variety v on pm.variety_id = v.id
      where vta.area_id = :areaId
      and pm.purchase_date =:targetDate
      and v.id=:varietyId
      )t1
join (select 1 id, 'PURCHASE' status
            union all
            select 2, 'CLASSIFICATION_FIRST' status
            )t2 ON t1.weight_recipient=t2.status)t3
join   (select  x.bale_id,x.grade_id
        from(select  a.bale_id,a.grade_id,
        RANK() OVER (PARTITION BY a.bale_id ORDER BY b.id DESC) rank
        from(select bale_id,grade_id,grade_provider from bale_grade)a
        join
        (select 1 id, 'BUYER' status union all select 2, 'CLASSIFIER' status)b
        on a.grade_provider=b.status)x
        where x.rank=1) bg
        on t3.bale_id=bg.bale_id
join    grade g on bg.grade_id = g.id
where   t3.rank=1
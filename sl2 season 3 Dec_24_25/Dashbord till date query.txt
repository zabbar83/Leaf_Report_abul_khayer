select  vta.area_id areaId,
                    vta.area_name areaName,
                    v.id as varietyId,
                    v.variety_name varietyName,
                    count(pd.bale_id) totalNumberOfPurchasedBale,
                    sum(weight) totalWeight,
                    sum(amount) as totalAmount
            from        purchase_main pm
                     inner join purchase_details pd
                                on pm.id = pd.purchase_main_id
                    and pd.bale_id not in (select id from bale where bale_accept_status ='REJECTED')
                    inner join farmer_contact fc on pm.farmer_contact_id = fc.id
                    and fc.season_id= :seasonId
                    inner join farmer f on fc.farmer_id = f.id
                    inner join grade g
                                on pd.grade_id = g.id
                    inner join variety v
                                on g.variety_id = v.id
                    inner join v_territory_all vta on f.territory_id=vta.vill_id
            where pm.purchase_date <= current_date
            AND case when :areaId is not null then vta.area_id=:areaId else true end
            group by vta.area_id,vta.area_name,v.id, v.variety_name
            order by vta.area_id,v.id
SELECT
       d.area_id                                  AS areaId,
       vta.area_name                              AS areaName,
       d.depot_id                                 AS depotId,
       coalesce(d.depot_name, vta.area_name)      AS depotName,
       d.loan_item_id                             AS loanItemId,
       d.item_name                                AS itemName,
       d.unit                                     AS unit,

       COALESCE(SUM(daRec.dRecQntfArea), 0)       AS dRecQntfArea,
       COALESCE(SUM(ddRecTo.dtdRecQnt_to), 0)     AS dtdRecQnt_to,
       COALESCE(SUM(ddRecFrom.dtdRecQnt_from), 0) AS dtdRecQnt_from,
       COALESCE(SUM(farDis.fDistributionStk), 0)  AS fDistributionStk,
       COALESCE(SUM(dis.depotInvStock), 0)        AS depotInvStock

FROM (SELECT DISTINCT area_id, area_name
      FROM v_teritory_all) vta

JOIN (
        SELECT
               li.area_id   AS area_id,
               d.id         AS depot_id,
               d.depot_name AS depot_name,
               li.id        AS loan_item_id,
               li.item_name AS item_name,
               li.unit      AS unit
        FROM depot d
        JOIN (
                SELECT li.*, lir.area_id
                FROM loan_items li
                JOIN loan_items_rate lir
                     ON li.id = lir.loan_item_id
                    AND li.id NOT IN (1,2,3)
             ) li
             ON d.area_id = li.area_id
        WHERE li.area_id = :areaId
          AND ( :depotId = 0 OR d.id = :depotId )
     ) d
     ON vta.area_id = d.area_id

LEFT JOIN (
            SELECT
                   dld.to_depot_id   AS depot_id,
                   dldi.loan_item_id AS loan_item_id,
                   SUM(dldi.depot_receive_quantity) dRecQntfArea
            FROM depot_li_disbursement dld
            JOIN (
                    SELECT *
                    FROM depot_li_disbursement_item dldi
                    CROSS JOIN (
                                SELECT *
                                FROM season
                                WHERE current_date BETWEEN ed AND td
                               ) s
                    WHERE dldi.received_datetime::date
                          BETWEEN s.ed AND s.td
                 ) dldi
              ON dld.id = dldi.depot_li_disbursement_id
             AND dld.status = 'RECEIVED'
            GROUP BY dld.to_depot_id, dldi.loan_item_id
          ) daRec
       ON d.depot_id = daRec.depot_id
      AND d.loan_item_id = daRec.loan_item_id

LEFT JOIN (
            SELECT
                   dtdld.to_depot_id                  AS depot_id,
                   dtdldi.loan_item_id                AS loan_item_id,
                   SUM(dtdldi.depot_receive_quantity) AS dtdRecQnt_to
            FROM depot_to_depot_li_disbursement dtdld
            JOIN (
                    SELECT *
                    FROM depot_to_depot_li_disbursement_item dtdldi
                    CROSS JOIN (
                                SELECT *
                                FROM season
                                WHERE current_date BETWEEN ed AND td
                               ) s
                    WHERE dtdldi.received_datetime::date
                          BETWEEN s.ed AND s.td
                 ) dtdldi
              ON dtdld.id = dtdldi.depot_to_depot_li_disbursement_id
             AND dtdld.status = 'RECEIVED'
            GROUP BY dtdld.to_depot_id, dtdldi.loan_item_id
          ) ddRecTo
       ON d.depot_id = ddRecTo.depot_id
      AND d.loan_item_id = ddRecTo.loan_item_id

LEFT JOIN (
            SELECT
                   dtdld.from_depot_id                AS depot_id,
                   dtdldi.loan_item_id                AS loan_item_id,
                   SUM(dtdldi.depot_receive_quantity) AS dtdRecQnt_from
            FROM depot_to_depot_li_disbursement dtdld
            JOIN (
                    SELECT *
                    FROM depot_to_depot_li_disbursement_item dtdldi
                    CROSS JOIN (
                                SELECT *
                                FROM season
                                WHERE current_date BETWEEN ed AND td
                               ) s
                    WHERE dtdldi.received_datetime::date
                          BETWEEN s.ed AND s.td
                 ) dtdldi
              ON dtdld.id = dtdldi.depot_to_depot_li_disbursement_id
             AND dtdld.status = 'RECEIVED'
            GROUP BY dtdld.from_depot_id, dtdldi.loan_item_id
          ) ddRecFrom
       ON d.depot_id = ddRecFrom.depot_id
      AND d.loan_item_id = ddRecFrom.loan_item_id

LEFT JOIN (
            SELECT
                   dlds.depot_id      AS depot_id,
                   dlds.loan_item_id  AS loan_item_id,
                   SUM(dlds.quantity) AS fDistributionStk
            FROM daily_li_distribution_summary dlds
            WHERE season_id IN (
                    SELECT CAST(attribute_value AS numeric)
                    FROM global_setting
                    WHERE attribute_name = 'REGISTRATION_SEASON'
                  )
            GROUP BY dlds.depot_id, dlds.loan_item_id
          ) farDis
       ON d.depot_id = farDis.depot_id
      AND d.loan_item_id = farDis.loan_item_id

LEFT JOIN (
            SELECT
                   dli.depot_id     AS depot_id,
                   dli.loan_item_id AS loan_item_id,
                   SUM(dli.quantity) depotInvStock
            FROM depot_li_inventory dli
            GROUP BY dli.depot_id, dli.loan_item_id
          ) dis
       ON d.depot_id = dis.depot_id
      AND d.loan_item_id = dis.loan_item_id

GROUP BY GROUPING SETS (
   (d.area_id, vta.area_name, d.depot_id, d.depot_name, d.loan_item_id, d.item_name, d.unit),
   (d.area_id, d.loan_item_id, d.item_name, d.unit)
), vta.area_name
ORDER BY d.depot_id, d.loan_item_id
select
    v.id as varietyId,
    v.variety_name as varietyName,
    g.id,
    g.grade_name gradeName,
    count(pd.bale_id) nosofBale,
    coalesce(sum(pd.weight),0) weight,
    coalesce(max(tw.total_weight),0) totalWeight,
    coalesce(sum(pd.amount),0) amount,
    coalesce(sum(bb.bonus_amount),0) bonus,
    coalesce(sum(pd.amount),0) + coalesce(sum(bb.bonus_amount),0) totalAmount,
    case when coalesce(max(tw.total_weight),0) > 0
             then (coalesce(sum(pd.weight),0) / coalesce(max(tw.total_weight),0)) * 100
         else 0 end contribution,
    case when coalesce(sum(pd.weight),0) > 0
             then (coalesce(sum(pd.amount),0) + coalesce(sum(bb.bonus_amount),0)) / coalesce(sum(pd.weight),0)
         else 0 end average
from    bale_grade bg
            join    (select * from grade where grade_provider='BUYER' and season_id=:season) g on bg.grade_id=g.id
    and     bg.grade_provider = 'BUYER'
            join    variety v on g.variety_id = v.id
    and     v.id in (:varietyId)
            join    purchase_details pd on bg.bale_id=pd.bale_id
            join    purchase_main pm on pd.purchase_main_id = pm.id
    and     pm.purchase_date between to_date(:fromDate,'yyyy-mm-dd') and to_date(:toDate,'yyyy-mm-dd')
            join    farmer_agreement fa on pm.agreement_id = fa.id and g.area_id=fa.area_id
    and (case when :areaId is not null then fa.area_id = :areaId else true end)
    and (case when :zoneId is not null then fa.zone_id = :zoneId else true end)
    and (case when :subAreaId is not null then fa.sub_area_id = :subAreaId else true end)
    and (case when :villageId is not null then fa.village_id = :villageId else true end)
            join    season s on fa.season_id = s.id
    and     s.id=:season
            left    join bale_bonus bb on pd.bale_id=bb.bale_id
                    join (select
                              v.id varietyId,
                              v.variety_name varietyName,
                              coalesce(sum(pd.weight),0) total_weight
                          from    bale_grade bg
                                      join    (select * from grade where grade_provider='BUYER' and season_id=:season) g on bg.grade_id=g.id
                              and     bg.grade_provider = 'BUYER'
                                      join    variety v on g.variety_id = v.id
                              and     v.id in (:varietyId)
                                      join    purchase_details pd on bg.bale_id=pd.bale_id
                                      join    purchase_main pm on pd.purchase_main_id = pm.id
                              and     pm.purchase_date between to_date(:fromDate,'yyyy-mm-dd') and to_date(:toDate,'yyyy-mm-dd')
                                      join    farmer_agreement fa on pm.agreement_id = fa.id and g.area_id=fa.area_id
                              and (case when :areaId is not null then fa.area_id = :areaId else true end)
                              and (case when :zoneId is not null then fa.zone_id = :zoneId else true end)
                              and (case when :subAreaId is not null then fa.sub_area_id = :subAreaId else true end)
                              and (case when :villageId is not null then fa.village_id = :villageId else true end)
                                      join    season s on fa.season_id = s.id
                              and     s.id=:season
                                      left    join bale_bonus bb on pd.bale_id=bb.bale_id
                          group by v.id,v.variety_name) tw on v.id=tw.varietyId
group by v.id,v.variety_name,g.id,g.grade_name
order  by v.id,g.id